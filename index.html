<!DOCTYPE html>
<html>

<head>
    <title>Schloss Lab Experiment</title>
    <!-- Load in the jspsych tools, plugins,and layout -->
    <script src="jsPsych/jspsych.js"></script>

    <script src="jsPsych/plugin-html-button-response.js"></script>
    <script src="jsPsych/plugin-html-keyboard-response.js"></script>
    <script src="jsPsych/plugin-survey-html-form.js"></script>
    <script src="jsPsych/plugin-survey-multi-select.js"></script>
    <script src="jsPsych/plugin-survey-multi-choice.js"></script>
    <script src="jsPsych/plugin-survey-text.js"></script>
    <script src="jsPsych/plugin-fullscreen.js"></script>
    <script src="jsPsych/plugin-preload.js"></script>
    <!-- <script src="imagePaths.js"></script> -->
    <script src="exp0_conditions.js"></script>
    <link href="jsPsych/jspsych.css" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>


</head>

<body>


    <!--------------------- Here is where the experiment is created ------------------------------------------->
    <script>




        async function createExperiment() {

            var jsPsych = initJsPsych({
                on_finish: function () {
                    jsPsych.data.get().localSave("csv", filename);
                }
            }
            );
            var timeline = [];

            //Set background to grey
            document.body.style.backgroundColor = "rgb(128,128,128)"

            console.log(textures.length)
            //get the SONA id from the url

            //data pipe: CohtFpw9fJKx


            //const sona_id = jsPsych.data.getURLVariable('id');
            const subject_id = jsPsych.randomization.randomID(10);

            const filename = `${subject_id}.csv`;

            //const condition_num = await jsPsychPipe.getCondition("CohtFpw9fJKx");
            // const condition_num = 0;

            //Limit conditions run

            // Map condition_num to one of the three conditions
            /*let assigned_condition;
            if (condition_num >= 0 && condition_num <= 6) {
                assigned_condition = 11;
            } else if (condition_num >= 7 && condition_num <= 13) {
                assigned_condition = 13;
            } else {
                console.error("Unexpected condition number:", condition_num);
            }*/

            // Use the assigned condition number to get the concept list
            //concept_list = concept_conds[assigned_condition];
            //concept_list = jsPsych.randomization.shuffle(concept_list);

            // Prompt for participant ID
            var participant_id = prompt("Please enter the participant ID:");

            // Ensure input is valid
            if (!participant_id || isNaN(participant_id)) {
                alert("Invalid participant ID! Please reload the page and enter a numeric ID.");
                throw new Error("Invalid participant ID.");
            }

            // Calculate the condition index
            var condition_index = parseInt(participant_id) % 14;

            // Assign the correct list based on the condition index
            /*var textures;
            var list_name;
            if (condition_index === 0) {
                textures = textures_list1;
                list_name = "textures_list1";
            } else if (condition_index === 1) {
                textures = textures_list2;
                list_name = "textures_list2";
            } else {
                textures = textures_list3;
                list_name = "textures_list3";
            }*/


            //ALL conditions
            console.log("participant_id:", participant_id)
            console.log("condition_index:", condition_index)
            condition_num = condition_index - 1;
            console.log("condition_num:", condition_num)
            concept_list = concept_conds[condition_num]
            console.log("concept_list:", concept_list)
            concept_list = jsPsych.randomization.shuffle(concept_list);
            texture_list = jsPsych.randomization.shuffle(textures);



            jsPsych.data.addProperties({
                subject_id: subject_id,
                participant_id: participant_id
                //condition_num: condition_num,
                //sona_id: sona_id
            });

            // Initial welcome screen
            var initial_screen = {
                type: jsPsychHtmlButtonResponse,
                stimulus: 'Welcome to the experiment!' +
                    '<p>[At the bottom of this screen, you will see a button that says "Begin Experiment".]' +
                    '<p>[Click the button to begin the experiment.]</p>',
                choices: ['Begin Experiment']
            }
            timeline.push(initial_screen);
            let preload_trial = {
                type: jsPsychPreload
            }
            timeline.push(preload_trial);

            timeline.push({
                type: jsPsychFullscreen,
                fullscreen_mode: true,
            })


            var instructions1 = {
                type: jsPsychHtmlButtonResponse,
                //type: jsPsychHtmlSliderResponse,
                stimulus: `
                        <div style="height:720px;">
                            <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                                During this experiment you will be presented with a series of texture bars and concepts. You will be asked to rate how much you associate each texture bar with each concept on a scale from "not at all" associated to "very much associated". <br>
                                The texture bars will be placed in the box in front of you so that you won't see them when you reach in to touch while making your ratings. The concepts you will be presented with are: \
                            </div>

                            <div style="text-align: left; width: 1200px;">
                                <p style="font-size:150%; line-height:20px; text-align:center; font-weight:bold ">${concept_list[0]},
                                    ${concept_list[1]}, ${concept_list[2]}, ${concept_list[3]}, ${concept_list[4]}
                                <p style="font-size:18px; line-height:18px;"></p>
                            </div>
                            <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                            </div>
                            <br>
                            <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                                Each trial will include one texture bar and one concept word. You will be asked to make your rating by
                                reporting how strongly you associate the texture with the concept on a scale from 1 to 9 where 1 means 'not at all' associated
                                and 9 means 'very much' associated.<br><br>\
                                Before beginning, I will present you with the full set of textures. I will present them 7 at a time in a sequence of 5 plates.\
                                Please feel all of the textures in each plate and think about which textures you associate most strongly and most weakly with each concept. \
                                We will begin with the 1st plate of 7 textures. As a reminder the concepts you will be rating are: <br><br>\
                                </div>
                                <span style = 'font-size:150%; text-align:center; font-weight: bold'>${concept_list[0]}, ${concept_list[1]}, ${concept_list[2]}, ${concept_list[3]}, ${concept_list[4]}</span><br><br>\
                                <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                                [Place anchoring plate one in the box and proceed through the remaining 4 in order until all textures have been felt. Watch to make sure the participant feels all the textures in a plate. Remind them of the concepts they will be rating.]<br><br>\
                                For each trial please say outloud a number from 1 to 9 to indicate how strongly you associate the current texture with the current concept. Again, a 1 indicates you do not associate the concept with the texture at all and a 9 indicates you very much associate the texture with the concept.<br><br>\
                                Please be sure to use the full range of the scale.<br><br>\
                                You will be asked to rate each concept for a given texture before moving on to the next. There are 5 blocks of trials. I will notify you when you have completed each block. Do you have any questions?<br><br>
                                [Click the 'Continue' button to start the trials when ready.]

                            </div>
                            <!-- Centered text paragraphs -->

                        </div>
                         `,
                choices: ['Continue'],
                data: {
                    practiceTrial: true,
                }
            }



            //instructions on the textures, box, and anchoring
            timeline.push(instructions1);

            var instructions2 = {
                type: jsPsychHtmlButtonResponse,
                //type: jsPsychHtmlSliderResponse,
                stimulus: `
                        <div style="height:720px;">
                            <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                                Each trial will include one texture bar and one concept word. You will be asked to make your rating by
                                reporting how strongly you associate the texture with the concept on a scale from 1 to 9 where 1 means 'not at all' associated
                                and 9 means 'very much' associated.<br><br>\
                                Before beginning, I will present you with the full set of textures. I will present them 7 at a time in a sequence of 5 plates.\
                                Please feel all of the textures in each plate and think about which textures you associate most strongly and most weakly with each concept.\
                                We will begin with the 1st plate of 7 textures. As a reminder the concepts you will be rating are: <br><br>\
                                </div>
                                <span style = 'font-size:150%; text-align:center; font-weight: bold'>${concept_list[0]}, ${concept_list[1]}, ${concept_list[2]}, ${concept_list[3]}, ${concept_list[4]}</span><br><br>\
                                <div style='text-align:left; font-size:18px; line-height:25px; width: 1200px;'>
                                [Place anchoring plate one in the box and proceed through the remaining 4 in order until all textures have been felt. Watch to make sure the participant feels all the textures in a plate. Remind them of the concepts they will be rating.]<br><br>\
                                For each trial please say outloud a number from 1 to 9 to indicate how strongly you associate the current texture with the current concept. Again, a 1 indicates you do not associate the concept with the texture at all and a 9 indicates you very much associate the texture with the concept.<br><br>\
                                Please be sure to use the full range of the scale.<br><br>\
                                You will be asked to rate each concept for a given texture before moving on to the next. There are 5 blocks of trials. I will notify you when you have completed each block. Do you have any questions?<br><br>
                                [Click the 'Continue' button to start the trials when ready.]

                            </div>
                            <!-- Centered text paragraphs -->

                        </div>
                         `,
                choices: ['Continue'],
                data: {
                    practiceTrial: true,
                }
            }



            //instructions on trials
            timeline.push(instructions2);

            let block_break_count = 0; // Initialize block break counter

            const first_7_textures = texture_list.slice(0, 7);
            var first_7_preview = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: "<p>[In this block of trials, the participant will be asked to rate how much they associate each concept with the textures]</p>" +
                    "<p style = 'font-size:150%; font-weight: bold'>" + first_7_textures.join(", ") + "</p><br></br>" +
                    "<p>[Take a moment to find a lay out the textures in order that they will rate in this block.]</p><br></br>" +
                    "<p>[Press 'Enter' to continue]</p>",

                choices: "ALL_KEYS",
            };

            timeline.push(first_7_preview);


            for (j = 0; j < texture_list.length; j++) {
                var block_break0 = {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: "<p>Texture:</p > " +
                        "<p style = 'font-size:150%; font-weight: bold'>" + texture_list[j] + "</p><br></br>" +
                        "<p>[Press 'Enter' to continue]</p>",
                    choices: "ALL_KEYS",
                };
                timeline.push(block_break0);
                trial_block = [];
                concept_order = jsPsych.randomization.shuffle(concept_list);
                for (i = 0; i < concept_order.length; i++) {
                    this_concept = concept_order[i];

                    this_texture = texture_list[j];
                    // Define concept based on current exemplar
                    var rating_trial = {
                        type: jsPsychSurveyText,
                        preamble: `<div style="width:500px;">
                            <p style="font-size:50px; font-weight:bold;"
                            >${this_texture}</p>
                            <p style="font-size:50px; font-weight:bold;"
                            >${this_concept}</p>
                        </div>`,
                        questions: [
                            {
                                prompt: "Participant rating:",
                                rows: 1,
                                columns: 50
                            }
                        ],
                        response_ends_trial: true,
                        data: {
                            // scale: this_scale,
                            concept: this_concept,
                            // image_path: this_map,
                            texture_id: this_texture,
                            // repetition: repetition,
                            // map_id: this_map.match(/\d{2}(?=\.png)/)[0], //extracts the map id from the image path
                            // hue: im2cond_dict[this_map]['hue'],
                            // lightness: im2cond_dict[this_map]['lightness'],
                            // saturation: im2cond_dict[this_map]['saturation'],
                        }

                    };
                    trial_block.push(rating_trial);




                }
                trial_block = jsPsych.randomization.shuffle(trial_block);
                timeline = _.concat(timeline, trial_block);


                if ((j + 1) % 7 === 0 && j !== texture_list.length - 1) {
                    block_break_count++;
                    // Get next 7 textures ready
                    const next_textures = texture_list.slice(j + 1, j + 8);
                    var block_break = {
                        type: jsPsychHtmlKeyboardResponse,
                        stimulus: `<p>
                            <b>You have completed ${Math.floor((j + 1) / 7)} of ${Math.ceil(texture_list.length / 7)} trial blocks.<br></br></b>
                            [For experimenter: You have completed ${j + 1} textures. There are ${texture_list.length - (j + 1)} textures left to go.]<br></br>
                            <b>Next up:</b><br></br>
                            <b><span style = 'font-size:150%; font-weight: bold'>${next_textures.join(", ")}</span></b><br><br>
                            [Take a moment to find and lay out the textures in order that they will rate in this block.]<br></br>
                            <br></br>
                            [Press 'Enter' to continue]</p>`,
                        choices: "ALL_KEYS",
                    };
                    timeline.push(block_break);
                }
            }



            const save_data = {
                type: jsPsychPipe,
                action: "save",
                experiment_id: "CohtFpw9fJKx",
                filename: filename,
                data_string: () => jsPsych.data.get().csv()
            };
            timeline.push(save_data);

            //spot for debrief

            var debrief_script = {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="width:800px">Great job! You have finished the experiment.' +
                    '<p> Our lab is generally interested in understanding how we can use touch to communicate about data, such as data found in weather maps or even journal articles about psychology research. <br>' +
                    '<p> This knowledge may contribute to the design of data “tactilizations” to make data more accessible for those who are visually impaired and to make touch systems easier to use for sighted observers like navigation systems in cars. <br>' +
                    "<p> Before we tackle this bigger question, we first need to figure out which textures people associate strongly and weakly with which concepts and how these associations align with people's expectatons about the meanings of textures in different contexts. <br>" +
                    '<p> In this experiment, you rated how much you associated each texture with some of the concepts we are studying, other particiants in this study may rate different concepts.\
                        We will use this data to design future experiments to investigate how we can use texture to communicate effectively.</p>' +
                    '<p> Do you have any questions?' +
                    '<p> Credit for your participation will be appear on SONA in the next few days.' +
                    '<p> Thank you for participating!</p></div>',
                choices: ['NO_KEYS']
            }
            timeline.push({
                type: jsPsychFullscreen,
                fullscreen_mode: false,
            })

            timeline.push(debrief_script);
            jsPsych.run(timeline);
        }

        createExperiment();


    </script>
</body>

</html> 